stages:
  - test
  - code_quality
  - sast
  - sca
  - dast

default:
  image: python:3.11

test-job:
  stage: test
  script:
    - echo "Running basic test stage"
    - pip install --upgrade pip
    - find . -name "*.py" -print0 | xargs -0 python -m py_compile

# Software Composition Analysis (SCA) - Checks for vulnerable dependencies
sca-scan:
  stage: sca
  image: python:3.11
  script:
    - echo "Running SCA scan to detect vulnerable dependencies..."
    - pip install --upgrade pip
    - pip install safety
    - pip install -r requirements.txt
    - echo "Scanning dependencies with Safety..."
    - safety check --json
    - echo "✅ SECURE VERSION - No known vulnerabilities detected!"
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
    when: always
  allow_failure: false

# Dynamic Application Security Testing (DAST)
dast-scan:
  stage: dast
  image: owasp/zap2docker-stable
  script:
    - echo "Running DAST scan on example.com..."
    - mkdir -p /zap/wrk
    - |
      /zap/zap-baseline.py -t https://www.example.com \
        -r dast-report.html \
        -J dast-report.json \
        || true
    - echo "✅ DAST scan completed - Secure configuration applied"
  artifacts:
    paths:
      - dast-report.html
      - dast-report.json
    expire_in: 1 week
    when: always
  allow_failure: true

include:
  - template: Code-Quality.gitlab-ci.yml
  - template: Jobs/SAST.gitlab-ci.yml
  - template: DAST.gitlab-ci.yml